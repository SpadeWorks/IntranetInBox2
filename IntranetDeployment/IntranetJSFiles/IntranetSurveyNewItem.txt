var INTRANET = {};
INTRANET.emailYes = false;
INTRANET.emailNo = false;
INTRANET.pollYes = false;
INTRANET.pollNo = false;;
$(document).ready(function () {


    INTRANET.surveyListName = $("input[title='Title']");
    INTRANET.surveyDescription = $("textarea[id='surveyDescription']");
    INTRANET.endDate = $("input[title='End Date']");
    INTRANET.isPollYes = $("input[id='isPollYes']");
    INTRANET.isPollNo = $("input[id='isPollNo']");
    INTRANET.emailNotificationYes = $("input[id='emailYes']");
    INTRANET.emailNotificationNo = $("input[id='emailNo']");
    INTRANET.endDate.prop('readOnly', 'readOnly');

    INTRANET.emailNotificationYes.change(function () {
        INTRANET.emailYes = !INTRANET.emailYes;
        INTRANET.emailNo = !INTRANET.emailYes;
    });
    INTRANET.emailNotificationNo.change(function () {
        INTRANET.emailNo = !INTRANET.emailNo;
        INTRANET.emailYes = !INTRANET.emailNo;
    });
    INTRANET.isPollYes.change(function () {
        INTRANET.pollYes = !INTRANET.pollYes;
        INTRANET.pollNo = !INTRANET.pollYes;
    });
    INTRANET.isPollNo.change(function () {
        INTRANET.pollNo = !INTRANET.pollNo;
        INTRANET.pollYes = !INTRANET.pollNo;
    });

    INTRANET.itemID = getParameterByName("ItemID");
    if (INTRANET.itemID != null || INTRANET.itemID != undefined) {
        setFieldValue(INTRANET.itemID);
    }

});
function PreSaveAction() {
    $(".validation").hide();

    if (!CheckError() && (INTRANET.itemID === undefined)) {
        createList(INTRANET.surveyListName.val().trim());
    }
    else if (!CheckError() && INTRANET.itemID && INTRANET.previousListName != INTRANET.surveyListName.val()) {
    	updateSurveyListName(INTRANET.previousListName).then(function (data) {
	            if (data) {
	                updateListItem();
	            }
	        });
    }
    else if(!CheckError() && INTRANET.itemID)
    {
    	updateListItem();
    }
}

function updateSurveyListName(listName) {
    var deferred = $.Deferred(),
    	result = false,
    	siteUrl = _spPageContextInfo.webAbsoluteUrl,
    	context = new SP.context(siteUrl),
    	oWebsite = context.get_web(),
    	list = oWebsite.get_lists().getByTitle(listName);
    	
    list.set_title(INTRANET.surveyListName.val());
    list.update();
    context.executeQueryAsync(
        function (data) {
            result = true;
            deferred.resolve(result);
        },
        function (sender, args) {
            console.log(args.get_message());
            deferred.resolve(result);
        });
    return deferred.promise();
}

function updateListItem() {
    var siteUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Intranet Survey')/items('" + INTRANET.itemID + "')",
    	item = '{"__metadata":{"type": "SP.Data.IntranetSurveyListItem"},"Title":"' + INTRANET.surveyListName.val().trim() + '","EmailNotification":"' + (INTRANET.emailYes ? "Yes" : "No") + '","IsPoll":"' + (INTRANET.pollYes ? "Yes" : "No") + '","EndDate1":"' + INTRANET.endDate.val().trim() + '","SurveyDescription":"' + INTRANET.surveyDescription.val().trim() + '"}';
    obj = JSON.parse(item);
    $.ajax({
        url: siteUrl,
        type: 'POST',
        contentType: "application/json;odata=verbose",
        data: JSON.stringify(obj),
        headers: {
            "accept": "application/json;odata=verbose",
            "X-RequestDigest": $("#__REQUESTDIGEST").val(),
            "IF-MATCH": "*",
            "X-Http-Method": "PATCH"
        },
        success: function (data) {
            console.log(data);
            dialog.alert({
                title: "Successful!",
                message: "Survey List updates Successfully",
                animation: "fade",
                callback: function (value) {
                    window.location = "http://icsp2016dev102:20165/sites/NBB/Lists/IntranetSurvey/AllItems.aspx";
                }
            });
        },
        error: function (error) {
            console.log(error);
        }
    });
}

function setFieldValue(id) {
    getItemDetails(id).then(function (data) {
    	INTRANET.previousListName = data.Title;
        INTRANET.surveyListName.val(data.Title);
        INTRANET.surveyDescription.val(data.SurveyDescription);
        INTRANET.endDate.val(moment(new Date(data.EndDate1), "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY"));
        if (data.IsPoll === "Yes") {
            INTRANET.isPollYes.prop("checked", true);
            INTRANET.pollYes = true;
        }
        else {
            INTRANET.isPollNo.prop("checked", true);
            INTRANET.pollNo = true;
        }
        if (data.EmailNotification === "Yes") {
            INTRANET.emailNotificationYes.prop("checked", true);
            INTRANET.emailYes = true;
        }
        else {
            INTRANET.emailNotificationNo.prop("checked", true);
            INTRANET.emailNo = true;
        }
    });
}

function getItemDetails(id) {
    var deferred = $.Deferred(),
        siteUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Intranet Survey')/items?$select=Title,EmailNotification,EndDate1,IsPoll,SurveyDescription&$filter= Id eq '" + id + "'";
    $.ajax({
        url: siteUrl,
        method: 'GET',
        headers: { 'Accept': 'application/json; odata=nometadata' },
        success: function (data) {
            deferred.resolve(data.value[0]);
        },
        error: function (error) {
            console.log(error);
            deferred.resolve(error);
        }
    });
    return deferred.promise();
}
function createList(listName) {
    var deferred = $.Deferred(),
	result = false,
	siteUrl = _spPageContextInfo.webAbsoluteUrl,
	context = new SP.context(siteUrl),
	oWebsite = context.get_web(),
	listCreationInfo = new SP.ListCreationInformation();
    listCreationInfo.set_title(listName);
    listCreationInfo.set_templateType(SP.ListTemplateType.survey);
    this.oList = oWebsite.get_lists().add(listCreationInfo);
    context.load(oList);
    context.executeQueryAsync(Function.createDelegate(this, this.onQuerySucceeded), Function.createDelegate(this, this.onQueryFailed));
}
function onQuerySucceeded() {

    var guid = oList.get_id(),
    	manageQuestions = "/sites/NBB/_layouts/15/qstNew.aspx?List={" + guid._m_guidString$p$0 + "}",
    	surveyLink = "/sites/NBB/Lists/" + INTRANET.surveyListName.val().trim() + "/NewForm.aspx",
    	responseLink = "/sites/NBB/Lists/" + INTRANET.surveyListName.val().trim() + "/summary.aspx";
    AddtoList(manageQuestions, surveyLink, responseLink);
}

function onQueryFailed(sender, args) {
	dialog.alert({
                title: "Failed!",
                message: args.get_message(),
                animation: "fade",
                callback: function (value) {
                }
            });

    console.log('Request failed. ' + args.get_message() + '\n' + args.get_stackTrace());
}

function AddtoList(manageQuestions, surveyLink, responseLink) {
    var siteUrl = _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/getbytitle('Intranet Survey')/items",
    item = '{"__metadata":{"type": "SP.Data.IntranetSurveyListItem"},"ManageQuestions":{"__metadata":{"type":"SP.FieldUrlValue"},"Url":"' + manageQuestions + '","Description":"Manage Questions"},"ViewResponse":{"__metadata":{"type":"SP.FieldUrlValue"},"Url":"' + responseLink + '","Description":"View Response"},"SurveyLink":{"__metadata":{"type":"SP.FieldUrlValue"},"Url":"' + surveyLink + '","Description":"Survey Link"},"Title":"' + INTRANET.surveyListName.val().trim() + '","EmailNotification":"' + (INTRANET.emailYes ? "Yes" : "No") + '","IsPoll":"' + (INTRANET.pollYes ? "Yes" : "No") + '","EndDate1":"' + INTRANET.endDate.val().trim() + '","SurveyDescription":"' + INTRANET.surveyDescription.val().trim() + '"}';
    obj = JSON.parse(item);
    $.ajax({
        url: siteUrl,
        type: 'POST',
        contentType: "application/json;odata=verbose",
        data: JSON.stringify(obj),
        headers: {
            "Accept": "application/json;odata=verbose",
            "X-RequestDigest": $("#__REQUESTDIGEST").val()
        },
        success: function (data) {
            //alert("Your Response saved Successfully");
            dialog.alert({
                title: "Successful!",
                message: "New Survey List Created Successfully",
                animation: "fade",
                callback: function (value) {
                    window.location = "http://icsp2016dev102:20165/sites/NBB/Lists/IntranetSurvey/AllItems.aspx";
                }
            });
        },
        error: function (error) {
            console.log(error);
        }
    });
}

function CheckError() {
    var error = false;
    if (!INTRANET.emailYes && !INTRANET.emailNo) {
        $("#email").show();
        error = true;
    }
    if (!INTRANET.pollYes && !INTRANET.pollNo) {
        $("#isPoll").show();
        error = true;
    }
    if (INTRANET.endDate.val() === "" || INTRANET.endDate.val() === null) {
        $("#endDate").show();
        INTRANET.endDate.focus();
        error = true;
    }
    if (INTRANET.surveyDescription.val().trim() == "" || INTRANET.surveyDescription.val().trim() == null) {
        $("#description").show();
        INTRANET.surveyDescription.focus();
        error = true;
    }
    if (INTRANET.surveyListName.val().trim() == "" || INTRANET.surveyListName.val().trim() == null) {
        $("#title").show();
        INTRANET.surveyListName.focus();
        error = true;
    }
    return error;
}

function getParameterByName(paramname) {
    JSRequest.EnsureSetup();
    return JSRequest.QueryString["" + paramname + ""];
}
